<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biwenger Budget Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .budget-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .budget-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .budget-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px rgba(0,0,0,0.15);
        }

        .budget-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .budget-card.current-user {
            border: 2px solid #4CAF50;
        }

        .budget-card.current-user::before {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .team-info h3 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .team-info p {
            color: #666;
            font-size: 0.9rem;
        }

        .position-badge {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .position-badge.top3 {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .position-badge.bottom3 {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .budget-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .movements-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .movements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .movements-header h2 {
            color: #333;
            font-size: 1.8rem;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .filter-btn.active,
        .filter-btn:hover {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }

        .movements-timeline {
            position: relative;
            padding-left: 40px;
        }

        .movements-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #667eea, #764ba2);
        }

        .movement-item {
            position: relative;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }

        .movement-item:hover {
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .movement-item::before {
            content: '';
            position: absolute;
            left: -32px;
            top: 24px;
            width: 12px;
            height: 12px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 50%;
        }

        .movement-item.transfer {
            border-left-color: #2196F3;
        }

        .movement-item.market {
            border-left-color: #4CAF50;
        }

        .movement-item.bid {
            border-left-color: #FF9800;
        }

        .movement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .movement-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .movement-type.transfer {
            background: #E3F2FD;
            color: #2196F3;
        }

        .movement-type.market {
            background: #E8F5E9;
            color: #4CAF50;
        }

        .movement-type.bid {
            background: #FFF3E0;
            color: #FF9800;
        }

        .movement-date {
            color: #666;
            font-size: 0.85rem;
        }

        .movement-details {
            margin-top: 10px;
        }

        .movement-teams {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .team-badge {
            padding: 4px 8px;
            background: #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .arrow {
            color: #666;
        }

        .movement-player {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .movement-price {
            color: #4CAF50;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .analytics-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .analytics-header {
            margin-bottom: 20px;
        }

        .analytics-header h2 {
            color: #333;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .insight-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .insight-card.warning {
            background: linear-gradient(135deg, #FF5722 0%, #E64A19 100%);
        }

        .insight-card.success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .insight-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .insight-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid rgba(102, 126, 234, 0.1);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            background: linear-gradient(45deg, #FFF3E0, #FFE0B2);
            border: 1px solid #FFB74D;
            color: #E65100;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-icon {
            font-size: 1.5rem;
        }

        @media (max-width: 768px) {
            .budget-overview {
                grid-template-columns: 1fr;
            }
            
            .budget-stats {
                grid-template-columns: 1fr;
            }
            
            .filter-buttons {
                flex-wrap: wrap;
            }
            
            .movements-timeline {
                padding-left: 20px;
            }
            
            .movements-timeline::before {
                left: 5px;
            }
            
            .movement-item::before {
                left: -22px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Sistema de Seguimiento de Presupuestos</h1>
            <p>An√°lisis detallado de movimientos y presupuestos de cada equipo en tu liga de Biwenger</p>
        </div>

        <div class="alert">
            <span class="alert-icon">‚ö†Ô∏è</span>
            <div>
                <strong>Presupuesto inicial:</strong> ‚Ç¨11,836,080 por equipo
                <br>
                <small>Los c√°lculos se basan en este presupuesto inicial y los movimientos detectados en el tabl√≥n.</small>
            </div>
        </div>

        <!-- Vista general de presupuestos -->
        <div id="budgetOverview" class="budget-overview">
            <div class="loading">
                <div class="spinner"></div>
                <p>Cargando datos de presupuestos...</p>
            </div>
        </div>

        <!-- Movimientos recientes -->
        <div class="movements-section">
            <div class="movements-header">
                <h2>üìä Movimientos del Mercado</h2>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterMovements('all')">Todos</button>
                    <button class="filter-btn" onclick="filterMovements('transfer')">Traspasos</button>
                    <button class="filter-btn" onclick="filterMovements('market')">Mercado</button>
                    <button class="filter-btn" onclick="filterMovements('today')">Hoy</button>
                </div>
            </div>
            <div id="movementsTimeline" class="movements-timeline">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Cargando movimientos...</p>
                </div>
            </div>
        </div>

        <!-- An√°lisis y estad√≠sticas -->
        <div class="analytics-section">
            <div class="analytics-header">
                <h2>üìà An√°lisis de Mercado</h2>
                <p>Tendencias y patrones en los movimientos de tu liga</p>
            </div>
            
            <div class="chart-container">
                <canvas id="budgetChart"></canvas>
            </div>
            
            <div id="insightsGrid" class="insights-grid">
                <div class="insight-card">
                    <div class="insight-value" id="totalTransactions">0</div>
                    <div class="insight-label">Transacciones Totales</div>
                </div>
                <div class="insight-card success">
                    <div class="insight-value" id="averageBudget">‚Ç¨0</div>
                    <div class="insight-label">Presupuesto Promedio</div>
                </div>
                <div class="insight-card warning">
                    <div class="insight-value" id="biggestSpender">-</div>
                    <div class="insight-label">Mayor Gastador</div>
                </div>
                <div class="insight-card">
                    <div class="insight-value" id="mostActive">-</div>
                    <div class="insight-label">M√°s Activo</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Estado global
        const INITIAL_BUDGET = 11836080;
        let teamsData = {};
        let movements = [];
        let boardData = [];
        let currentFilter = 'all';

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            initializeBudgetTracker();
        });

        async function initializeBudgetTracker() {
            try {
                // Cargar datos desde la API
                const response = await fetch('/api/board-analysis');
                if (response.ok) {
                    const data = await response.json();
                    processData(data);
                } else {
                    // Datos de ejemplo para demo
                    loadDemoData();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                loadDemoData();
            }
        }

        function loadDemoData() {
            // Datos de ejemplo para demostraci√≥n
            const demoTeams = [
                { id: 1, name: 'Real Madrid CF', position: 1, points: 245, currentBudget: 8500000 },
                { id: 2, name: 'FC Barcelona', position: 2, points: 238, currentBudget: 9200000 },
                { id: 3, name: 'Atl√©tico Madrid', position: 3, points: 220, currentBudget: 7800000 },
                { id: 4, name: 'Valencia CF', position: 4, points: 198, currentBudget: 10500000 },
                { id: 5, name: 'Sevilla FC', position: 5, points: 187, currentBudget: 6900000 }
            ];

            const demoMovements = [
                {
                    type: 'transfer',
                    date: new Date(Date.now() - 3600000),
                    from: 'Real Madrid CF',
                    to: 'FC Barcelona',
                    player: 'Pedri Gonz√°lez',
                    price: 3500000
                },
                {
                    type: 'market',
                    date: new Date(Date.now() - 7200000),
                    team: 'Atl√©tico Madrid',
                    player: 'Jo√£o F√©lix',
                    price: 5200000,
                    action: 'sold'
                },
                {
                    type: 'bid',
                    date: new Date(Date.now() - 10800000),
                    team: 'Valencia CF',
                    player: 'Carlos Soler',
                    price: 2800000,
                    action: 'bought'
                }
            ];

            // Procesar datos de demo
            demoTeams.forEach(team => {
                teamsData[team.id] = {
                    ...team,
                    transactions: [],
                    spent: INITIAL_BUDGET - team.currentBudget,
                    received: 0
                };
            });

            movements = demoMovements;
            
            // Actualizar UI
            updateBudgetOverview();
            updateMovementsTimeline();
            updateAnalytics();
        }

        function processData(data) {
            // Procesar datos del tabl√≥n
            if (data.board) {
                boardData = data.board;
                extractMovements(boardData);
            }

            // Procesar datos de equipos
            if (data.teams) {
                data.teams.forEach(team => {
                    teamsData[team.id] = {
                        ...team,
                        currentBudget: INITIAL_BUDGET,
                        transactions: [],
                        spent: 0,
                        received: 0
                    };
                });
            }

            // Calcular presupuestos basados en movimientos
            calculateBudgets();
            
            // Actualizar UI
            updateBudgetOverview();
            updateMovementsTimeline();
            updateAnalytics();
        }

        function extractMovements(board) {
            movements = [];
            
            board.forEach(entry => {
                if (entry.type === 'transfer') {
                    // Procesar transferencias
                    const transfer = parseTransferEntry(entry);
                    if (transfer) movements.push(transfer);
                } else if (entry.type === 'market') {
                    // Procesar movimientos de mercado
                    const marketMove = parseMarketEntry(entry);
                    if (marketMove) movements.push(marketMove);
                }
            });

            // Ordenar por fecha
            movements.sort((a, b) => b.date - a.date);
        }

        function parseTransferEntry(entry) {
            // Parsear entrada de transferencia del tabl√≥n
            // Formato esperado: "transfer - Player X from Team A to Team B - ‚Ç¨XXX"
            try {
                const content = entry.content || entry.text || '';
                const match = content.match(/(.+) from (.+) to (.+) - ‚Ç¨?([\d,]+)/);
                
                if (match) {
                    return {
                        type: 'transfer',
                        date: new Date(entry.date * 1000),
                        player: match[1].trim(),
                        from: match[2].trim(),
                        to: match[3].trim(),
                        price: parseInt(match[4].replace(/,/g, ''))
                    };
                }
            } catch (error) {
                console.error('Error parsing transfer:', error);
            }
            return null;
        }

        function parseMarketEntry(entry) {
            // Parsear entrada de mercado del tabl√≥n
            try {
                const content = entry.content || entry.text || '';
                const match = content.match(/(.+) (bought|sold) (.+) for ‚Ç¨?([\d,]+)/);
                
                if (match) {
                    return {
                        type: 'market',
                        date: new Date(entry.date * 1000),
                        team: match[1].trim(),
                        action: match[2],
                        player: match[3].trim(),
                        price: parseInt(match[4].replace(/,/g, ''))
                    };
                }
            } catch (error) {
                console.error('Error parsing market entry:', error);
            }
            return null;
        }

        function calculateBudgets() {
            // Resetear presupuestos
            Object.values(teamsData).forEach(team => {
                team.currentBudget = INITIAL_BUDGET;
                team.spent = 0;
                team.received = 0;
                team.transactions = [];
            });

            // Procesar cada movimiento
            movements.forEach(movement => {
                if (movement.type === 'transfer') {
                    // El equipo que vende recibe dinero
                    const fromTeam = Object.values(teamsData).find(t => t.name === movement.from);
                    if (fromTeam) {
                        fromTeam.currentBudget += movement.price;
                        fromTeam.received += movement.price;
                        fromTeam.transactions.push({...movement, impact: '+' + formatMoney(movement.price)});
                    }

                    // El equipo que compra gasta dinero
                    const toTeam = Object.values(teamsData).find(t => t.name === movement.to);
                    if (toTeam) {
                        toTeam.currentBudget -= movement.price;
                        toTeam.spent += movement.price;
                        toTeam.transactions.push({...movement, impact: '-' + formatMoney(movement.price)});
                    }
                } else if (movement.type === 'market') {
                    const team = Object.values(teamsData).find(t => t.name === movement.team);
                    if (team) {
                        if (movement.action === 'bought') {
                            team.currentBudget -= movement.price;
                            team.spent += movement.price;
                            team.transactions.push({...movement, impact: '-' + formatMoney(movement.price)});
                        } else if (movement.action === 'sold') {
                            team.currentBudget += movement.price;
                            team.received += movement.price;
                            team.transactions.push({...movement, impact: '+' + formatMoney(movement.price)});
                        }
                    }
                }
            });
        }

        function updateBudgetOverview() {
            const container = document.getElementById('budgetOverview');
            const teams = Object.values(teamsData).sort((a, b) => b.currentBudget - a.currentBudget);
            
            container.innerHTML = teams.map(team => {
                const positionClass = team.position <= 3 ? 'top3' : team.position > teams.length - 3 ? 'bottom3' : '';
                const isCurrentUser = team.isCurrentUser || false;
                const budgetPercentage = ((team.currentBudget / INITIAL_BUDGET) * 100).toFixed(1);
                
                return `
                    <div class="budget-card ${isCurrentUser ? 'current-user' : ''}">
                        <div class="team-header">
                            <div class="team-info">
                                <h3>${team.name} ${isCurrentUser ? '(T√∫)' : ''}</h3>
                                <p>${team.points || 0} puntos ‚Ä¢ ${team.transactions.length} movimientos</p>
                            </div>
                            <span class="position-badge ${positionClass}">${team.position}¬∫</span>
                        </div>
                        
                        <div class="budget-stats">
                            <div class="stat-item">
                                <div class="stat-value">${formatMoney(team.currentBudget)}</div>
                                <div class="stat-label">Presupuesto Actual</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${budgetPercentage}%</div>
                                <div class="stat-label">Del Inicial</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" style="color: #f44336;">-${formatMoney(team.spent)}</div>
                                <div class="stat-label">Gastado</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" style="color: #4CAF50;">+${formatMoney(team.received)}</div>
                                <div class="stat-label">Recibido</div>
                            </div>
                        </div>
                        
                        ${team.transactions.length > 0 ? `
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                                <small style="color: #666;">√öltimo movimiento: ${team.transactions[0].player} (${team.transactions[0].impact})</small>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateMovementsTimeline() {
            const container = document.getElementById('movementsTimeline');
            let filteredMovements = [...movements];
            
            // Aplicar filtros
            if (currentFilter === 'transfer') {
                filteredMovements = filteredMovements.filter(m => m.type === 'transfer');
            } else if (currentFilter === 'market') {
                filteredMovements = filteredMovements.filter(m => m.type === 'market');
            } else if (currentFilter === 'today') {
                const today = new Date();
                filteredMovements = filteredMovements.filter(m => {
                    const moveDate = new Date(m.date);
                    return moveDate.toDateString() === today.toDateString();
                });
            }

            if (filteredMovements.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No hay movimientos que mostrar</p>';
                return;
            }

            container.innerHTML = filteredMovements.map(movement => {
                const date = new Date(movement.date);
                const dateStr = date.toLocaleDateString('es-ES', {
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                if (movement.type === 'transfer') {
                    return `
                        <div class="movement-item transfer">
                            <div class="movement-header">
                                <span class="movement-type transfer">Traspaso</span>
                                <span class="movement-date">${dateStr}</span>
                            </div>
                            <div class="movement-player">${movement.player}</div>
                            <div class="movement-teams">
                                <span class="team-badge">${movement.team}</span>
                            </div>
                            <div class="movement-price">${formatMoney(movement.price)}</div>
                        </div>
                    `;
                }
                
                return '';
            }).join('');
        }

        function updateAnalytics() {
            // Calcular estad√≠sticas
            const teams = Object.values(teamsData);
            const totalTransactions = movements.length;
            const averageBudget = teams.reduce((sum, team) => sum + team.currentBudget, 0) / teams.length;
            const biggestSpender = teams.reduce((max, team) => team.spent > max.spent ? team : max, teams[0]);
            const mostActive = teams.reduce((max, team) => team.transactions.length > max.transactions.length ? team : max, teams[0]);

            // Actualizar insights
            document.getElementById('totalTransactions').textContent = totalTransactions;
            document.getElementById('averageBudget').textContent = formatMoney(averageBudget);
            document.getElementById('biggestSpender').textContent = biggestSpender?.name || '-';
            document.getElementById('mostActive').textContent = mostActive?.name || '-';

            // Crear gr√°fico
            createBudgetChart();
        }

        function createBudgetChart() {
            const ctx = document.getElementById('budgetChart');
            if (!ctx) return;

            const teams = Object.values(teamsData).sort((a, b) => b.currentBudget - a.currentBudget);
            
            // Destruir gr√°fico anterior si existe
            if (window.budgetChartInstance) {
                window.budgetChartInstance.destroy();
            }

            window.budgetChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: teams.map(t => t.name),
                    datasets: [
                        {
                            label: 'Presupuesto Actual',
                            data: teams.map(t => t.currentBudget),
                            backgroundColor: 'rgba(102, 126, 234, 0.6)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'Gastado',
                            data: teams.map(t => t.spent),
                            backgroundColor: 'rgba(244, 67, 54, 0.6)',
                            borderColor: 'rgba(244, 67, 54, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'Recibido',
                            data: teams.map(t => t.received),
                            backgroundColor: 'rgba(76, 175, 80, 0.6)',
                            borderColor: 'rgba(76, 175, 80, 1)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'An√°lisis de Presupuestos por Equipo'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatMoney(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function filterMovements(filter) {
            currentFilter = filter;
            
            // Actualizar botones activos
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Actualizar timeline
            updateMovementsTimeline();
        }

        function formatMoney(amount) {
            if (!amount) return '‚Ç¨0';
            
            const absAmount = Math.abs(amount);
            if (absAmount >= 1000000) {
                return `‚Ç¨${(amount / 1000000).toFixed(1)}M`;
            } else if (absAmount >= 1000) {
                return `‚Ç¨${(amount / 1000).toFixed(0)}K`;
            } else {
                return `‚Ç¨${amount}`;
            }
        }

        // Funci√≥n para conectar con la API real de Biwenger
        async function fetchRealData() {
            try {
                // Intentar obtener datos reales del tabl√≥n
                const response = await fetch('/api/board');
                if (response.ok) {
                    const data = await response.json();
                    console.log('Board data received:', data);
                    
                    // Procesar datos reales del tabl√≥n
                    if (data.data?.board) {
                        processRealBoardData(data.data.board);
                    }
                }
            } catch (error) {
                console.error('Error fetching real data:', error);
            }
        }

        function processRealBoardData(board) {
            const realMovements = [];
            
            board.forEach(entry => {
                // Procesar seg√∫n el tipo de entrada del tabl√≥n
                if (entry.type === 'playerMovements' && entry.content) {
                    entry.content.forEach(movement => {
                        if (movement.type === 'transfer') {
                            realMovements.push({
                                type: 'transfer',
                                date: new Date(entry.date * 1000),
                                from: movement.from?.name || 'Equipo Origen',
                                to: movement.to?.name || 'Equipo Destino',
                                player: movement.player?.name || 'Jugador',
                                price: movement.amount || 0
                            });
                        } else if (movement.type === 'market') {
                            realMovements.push({
                                type: 'market',
                                date: new Date(entry.date * 1000),
                                team: movement.user?.name || 'Equipo',
                                player: movement.player?.name || 'Jugador',
                                price: movement.amount || 0,
                                action: movement.action || 'bought'
                            });
                        }
                    });
                } else if (entry.type === 'transfer' || entry.type === 'market') {
                    // Procesar otros tipos de movimientos
                    const movement = {
                        type: entry.type,
                        date: new Date(entry.date * 1000),
                        content: entry.content || entry.text || ''
                    };
                    
                    // Intentar parsear el contenido
                    if (entry.type === 'transfer' && entry.content) {
                        movement.from = entry.content.from?.name;
                        movement.to = entry.content.to?.name;
                        movement.player = entry.content.player?.name;
                        movement.price = entry.content.amount || 0;
                    }
                    
                    realMovements.push(movement);
                }
            });

            if (realMovements.length > 0) {
                movements = realMovements;
                console.log('Processed movements:', movements);
                
                // Actualizar la UI con datos reales
                calculateBudgets();
                updateBudgetOverview();
                updateMovementsTimeline();
                updateAnalytics();
            }
        }

        // Intentar cargar datos reales al inicio
        setTimeout(fetchRealData, 1000);
    </script>
</body>
</html>
